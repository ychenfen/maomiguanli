<div class="page-header">
    <h1 class="page-title">数据概览</h1>
    <p class="page-description">查看系统整体运行状况和关键指标</p>
</div>

<!-- Statistics Cards -->
<div id="statsCards"></div>

<!-- Charts Row -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
    <!-- User Growth Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">用户增长趋势</h3>
            <div>
                <button class="btn btn-sm btn-default" onclick="loadUserGrowth(7)">7天</button>
                <button class="btn btn-sm btn-default" onclick="loadUserGrowth(30)">30天</button>
            </div>
        </div>
        <div class="card-body">
            <canvas id="userGrowthChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Activity Statistics Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">活跃度统计</h3>
            <div>
                <button class="btn btn-sm btn-default" onclick="loadActivityStats(7)">7天</button>
                <button class="btn btn-sm btn-default" onclick="loadActivityStats(30)">30天</button>
            </div>
        </div>
        <div class="card-body">
            <canvas id="activityChart" style="max-height: 300px;"></canvas>
        </div>
    </div>
</div>

<!-- Rankings Row -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
    <!-- Popular Cats -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">热门猫咪排行</h3>
        </div>
        <div class="card-body">
            <div id="popularCats"></div>
        </div>
    </div>

    <!-- Active Users -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">活跃用户排行</h3>
        </div>
        <div class="card-body">
            <div id="activeUsers"></div>
        </div>
    </div>
</div>

<!-- System Health & Pending Tasks -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
    <!-- System Health -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">系统健康状态</h3>
        </div>
        <div class="card-body">
            <div id="systemHealth"></div>
        </div>
    </div>

    <!-- Pending Tasks -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">待处理任务</h3>
        </div>
        <div class="card-body">
            <div id="pendingTasks"></div>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">最新动态</h3>
    </div>
    <div class="card-body">
        <div id="recentActivities"></div>
    </div>
</div>

<script>
// Load dashboard data
async function loadDashboardData() {
    try {
        // Load statistics
        const statsResult = await ApiClient.get(API.dashboard.statistics);
        if (statsResult.code === 200) {
            displayStatistics(statsResult.data);
        }

        // Load charts
        loadUserGrowth(7);
        loadActivityStats(7);

        // Load rankings
        loadPopularCats();
        loadActiveUsers();

        // Load system health
        loadSystemHealth();

        // Load pending tasks
        loadPendingTasks();

        // Load recent activities
        loadRecentActivities();
    } catch (error) {
        console.error('Load dashboard error:', error);
        Toast.error('加载失败', '无法加载仪表板数据');
    }
}

// Display statistics cards
function displayStatistics(data) {
    const stats = [];

    // User statistics
    if (data.userStatistics) {
        stats.push({
            title: '用户总数',
            value: data.userStatistics.totalUsers || 0,
            label: `今日新增: ${data.userStatistics.todayNewUsers || 0}`,
            color: 'blue'
        });
    }

    // Cat statistics
    if (data.catStatistics) {
        stats.push({
            title: '猫咪总数',
            value: data.catStatistics.totalCats || 0,
            label: `可领养: ${data.catStatistics.adoptableCats || 0}`,
            color: 'green'
        });
    }

    // Content statistics
    if (data.contentStatistics) {
        stats.push({
            title: '社区动态',
            value: data.contentStatistics.totalDynamics || 0,
            label: `今日发布: ${data.contentStatistics.todayDynamics || 0}`,
            color: 'orange'
        });
    }

    // Verification statistics
    if (data.verificationStatistics) {
        stats.push({
            title: '待审核申请',
            value: data.verificationStatistics.pendingApplications || 0,
            label: '身份认证申请',
            color: 'red'
        });
    }

    // Financial statistics
    if (data.financialStatistics) {
        stats.push({
            title: '总收入',
            value: Utils.formatCurrency(data.financialStatistics.totalIncome),
            label: `本月: ${Utils.formatCurrency(data.financialStatistics.monthIncome)}`
        });

        stats.push({
            title: '总支出',
            value: Utils.formatCurrency(data.financialStatistics.totalExpense),
            label: `本月: ${Utils.formatCurrency(data.financialStatistics.monthExpense)}`
        });

        stats.push({
            title: '当前余额',
            value: Utils.formatCurrency(data.financialStatistics.currentBalance),
            label: `待处理: ${data.financialStatistics.pendingTransactions || 0}`
        });
    }

    StatsCardComponent.render(document.getElementById('statsCards'), stats);
}

// Load user growth chart
async function loadUserGrowth(days) {
    try {
        const result = await ApiClient.get(API.dashboard.userGrowth, { days });
        if (result.code === 200 && result.data) {
            renderLineChart('userGrowthChart', result.data, 'date', 'count', '用户数');
        }
    } catch (error) {
        console.error('Load user growth error:', error);
    }
}

// Load activity statistics chart
async function loadActivityStats(days) {
    try {
        const result = await ApiClient.get(API.dashboard.activityStats, { days });
        if (result.code === 200 && result.data) {
            renderLineChart('activityChart', result.data, 'date', 'count', '活跃度');
        }
    } catch (error) {
        console.error('Load activity stats error:', error);
    }
}

// Load popular cats
async function loadPopularCats() {
    try {
        const result = await ApiClient.get(API.dashboard.popularCats, { limit: 10 });
        if (result.code === 200 && result.data) {
            renderRanking('popularCats', result.data, 'name', 'viewCount', '浏览量');
        }
    } catch (error) {
        console.error('Load popular cats error:', error);
    }
}

// Load active users
async function loadActiveUsers() {
    try {
        const result = await ApiClient.get(API.dashboard.activeUsers, { limit: 10 });
        if (result.code === 200 && result.data) {
            renderRanking('activeUsers', result.data, 'username', 'activityScore', '活跃度');
        }
    } catch (error) {
        console.error('Load active users error:', error);
    }
}

// Load system health
async function loadSystemHealth() {
    try {
        const result = await ApiClient.get(API.dashboard.systemHealth);
        if (result.code === 200 && result.data) {
            renderSystemHealth(result.data);
        }
    } catch (error) {
        console.error('Load system health error:', error);
    }
}

// Load pending tasks
async function loadPendingTasks() {
    try {
        const result = await ApiClient.get(API.dashboard.pendingTasks);
        if (result.code === 200 && result.data) {
            renderPendingTasks(result.data);
        }
    } catch (error) {
        console.error('Load pending tasks error:', error);
    }
}

// Load recent activities
async function loadRecentActivities() {
    try {
        const result = await ApiClient.get(API.dashboard.recentActivities, { limit: 20 });
        if (result.code === 200 && result.data) {
            renderRecentActivities(result.data);
        }
    } catch (error) {
        console.error('Load recent activities error:', error);
    }
}

// Render line chart (simple canvas-based chart)
function renderLineChart(canvasId, data, xKey, yKey, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !data || data.length === 0) return;

    const ctx = canvas.getContext('2d');
    const width = canvas.width = canvas.offsetWidth;
    const height = canvas.height = 300;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Extract data
    const labels = data.map(d => d[xKey]);
    const values = data.map(d => d[yKey]);
    const maxValue = Math.max(...values);

    // Chart dimensions
    const padding = 40;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2;

    // Draw axes
    ctx.strokeStyle = '#dcdfe6';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();

    // Draw line
    ctx.strokeStyle = '#667eea';
    ctx.lineWidth = 2;
    ctx.beginPath();

    values.forEach((value, index) => {
        const x = padding + (chartWidth / (values.length - 1)) * index;
        const y = height - padding - (value / maxValue) * chartHeight;

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    ctx.stroke();

    // Draw points
    ctx.fillStyle = '#667eea';
    values.forEach((value, index) => {
        const x = padding + (chartWidth / (values.length - 1)) * index;
        const y = height - padding - (value / maxValue) * chartHeight;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
    });

    // Draw labels
    ctx.fillStyle = '#666';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    labels.forEach((label, index) => {
        const x = padding + (chartWidth / (labels.length - 1)) * index;
        ctx.fillText(label, x, height - padding + 20);
    });
}

// Render ranking list
function renderRanking(containerId, data, nameKey, valueKey, valueLabel) {
    const container = document.getElementById(containerId);
    if (!container || !data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无数据</div></div>';
        return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

    data.forEach((item, index) => {
        const rank = index + 1;
        const rankColor = rank === 1 ? '#f56c6c' : rank === 2 ? '#e6a23c' : rank === 3 ? '#67c23a' : '#909399';

        html += `
            <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                <div style="width: 24px; height: 24px; border-radius: 50%; background: ${rankColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                    ${rank}
                </div>
                <div style="flex: 1; font-size: 14px; color: var(--text-primary);">
                    ${item[nameKey]}
                </div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    ${valueLabel}: ${item[valueKey]}
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Render system health
function renderSystemHealth(data) {
    const container = document.getElementById('systemHealth');
    if (!container || !data) return;

    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

    Object.keys(data).forEach(key => {
        const status = data[key];
        const isHealthy = status === 'healthy' || status === true || status === 'UP';
        const statusColor = isHealthy ? 'var(--success)' : 'var(--danger)';
        const statusText = isHealthy ? '正常' : '异常';

        html += `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                <div style="font-size: 14px; color: var(--text-primary);">${key}</div>
                <div style="font-size: 14px; color: ${statusColor}; font-weight: 500;">● ${statusText}</div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Render pending tasks
function renderPendingTasks(data) {
    const container = document.getElementById('pendingTasks');
    if (!container || !data) return;

    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

    Object.keys(data).forEach(key => {
        const count = data[key];
        const badgeClass = count > 0 ? 'badge-danger' : 'badge-success';

        html += `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                <div style="font-size: 14px; color: var(--text-primary);">${key}</div>
                <span class="badge ${badgeClass}">${count}</span>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Render recent activities
function renderRecentActivities(data) {
    const container = document.getElementById('recentActivities');
    if (!container || !data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无动态</div></div>';
        return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

    data.forEach(activity => {
        html += `
            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--primary-start); margin-top: 6px;"></div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 4px;">
                        ${activity.description || activity.content}
                    </div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">
                        ${Utils.formatDate(activity.createdAt || activity.createTime)}
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Initialize dashboard
loadDashboardData();

// Auto refresh every 5 minutes
setInterval(loadDashboardData, 5 * 60 * 1000);
</script>

<style>
.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-card h3 {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.stat-card .value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.stat-card .label {
    font-size: 12px;
    color: #999;
}

.stat-card.blue { border-left: 4px solid #409EFF; }
.stat-card.green { border-left: 4px solid #67C23A; }
.stat-card.orange { border-left: 4px solid #E6A23C; }
.stat-card.red { border-left: 4px solid #F56C6C; }
</style>
