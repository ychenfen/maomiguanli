<!-- æçŒ®/æ‰“èµç®¡ç† -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ’ æçŒ®/æ‰“èµç®¡ç†</h2>
        <div class="card-actions">
            <button class="btn btn-primary btn-sm" onclick="refreshDonations()">åˆ·æ–°</button>
        </div>
    </div>
    <div class="card-body">
        <div class="filter-bar" style="margin-bottom:16px;display:flex;gap:10px;">
            <select id="donTypeFilter" onchange="refreshDonations()" style="padding:6px 12px;border:1px solid #ddd;border-radius:4px;">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="crowdfunding">é¡¹ç›®æçŒ®</option>
                <option value="cat">çŒ«å’ªæ‰“èµ</option>
            </select>
            <select id="donStatusFilter" onchange="refreshDonations()" style="padding:6px 12px;border:1px solid #ddd;border-radius:4px;">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="COMPLETED">å·²å®Œæˆ</option>
                <option value="PENDING">å¾…å¤„ç†</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table" id="donationTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç±»å‹</th>
                        <th>ç”¨æˆ·</th>
                        <th>ç›®æ ‡</th>
                        <th>é‡‘é¢(å…ƒ)</th>
                        <th>ç•™è¨€</th>
                        <th>æ”¯ä»˜æ–¹å¼</th>
                        <th>åŒ¿å</th>
                        <th>çŠ¶æ€</th>
                        <th>æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="donationBody">
                    <tr><td colspan="10" class="text-center">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="donationPagination" class="pagination-wrap"></div>
    </div>
</div>

<script>
(function() {
    let donPage = 1;
    const donSize = 10;

    window.refreshDonations = async function(page) {
        if (page) donPage = page;
        const tbody = document.getElementById('donationBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">åŠ è½½ä¸­...</td></tr>';
        try {
            const params = { page: donPage, size: donSize };
            const typeVal = document.getElementById('donTypeFilter').value;
            const statusVal = document.getElementById('donStatusFilter').value;
            if (statusVal) params.status = statusVal;

            const res = await API.get('/donation/page', params);
            if (res.code === 200 && res.data) {
                let records = res.data.records || [];
                // Client-side type filter
                if (typeVal === 'crowdfunding') records = records.filter(d => d.crowdfundingId);
                if (typeVal === 'cat') records = records.filter(d => d.catId && !d.crowdfundingId);

                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                tbody.innerHTML = records.map(d => {
                    const type = d.crowdfundingId ? 'é¡¹ç›®æçŒ®' : (d.catId ? 'çŒ«å’ªæ‰“èµ' : 'æçŒ®');
                    const typeBadge = d.crowdfundingId ? 'badge-primary' : 'badge-success';
                    const target = d.crowdfundingTitle || d.catName || '-';
                    return `<tr>
                        <td>${d.id}</td>
                        <td><span class="badge ${typeBadge}">${type}</span></td>
                        <td>${d.username || d.userId}</td>
                        <td>${target}</td>
                        <td style="font-weight:600;color:#e67e22;">Â¥${(d.amount || 0).toFixed ? d.amount.toFixed(2) : d.amount || 0}</td>
                        <td>${d.message || '-'}</td>
                        <td>${d.paymentMethod || '-'}</td>
                        <td>${d.isAnonymous ? 'æ˜¯' : 'å¦'}</td>
                        <td><span class="badge ${d.status==='COMPLETED'?'badge-success':d.status==='PENDING'?'badge-warning':'badge-secondary'}">${d.statusText || d.status || '-'}</span></td>
                        <td>${(d.createTime || '').replace('T', ' ').substring(0, 16)}</td>
                    </tr>`;
                }).join('');

                const totalPages = res.data.pages || Math.ceil((res.data.total || 0) / donSize);
                const pagDiv = document.getElementById('donationPagination');
                pagDiv.innerHTML = '';
                if (totalPages > 1) {
                    for (let i = 1; i <= totalPages; i++) {
                        pagDiv.innerHTML += `<button class="btn btn-sm ${i===donPage?'btn-primary':'btn-outline'}" onclick="refreshDonations(${i})">${i}</button> `;
                    }
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">åŠ è½½å¤±è´¥</td></tr>';
            }
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
    };

    refreshDonations();
})();
</script>
