<!-- 云养管理 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">☁️ 云养管理</h2>
        <div class="card-actions">
            <button class="btn btn-primary btn-sm" onclick="refreshCloudAdoptions()">刷新</button>
        </div>
    </div>
    <div class="card-body">
        <div class="filter-bar" style="margin-bottom:16px;">
            <select id="caStatusFilter" onchange="refreshCloudAdoptions()" style="padding:6px 12px;border:1px solid #ddd;border-radius:4px;">
                <option value="">全部状态</option>
                <option value="true">进行中</option>
                <option value="false">已结束</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table" id="cloudAdoptionTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户</th>
                        <th>猫咪</th>
                        <th>云养名称</th>
                        <th>月额(元)</th>
                        <th>开始日期</th>
                        <th>结束日期</th>
                        <th>状态</th>
                        <th>累计金额</th>
                        <th>创建时间</th>
                    </tr>
                </thead>
                <tbody id="cloudAdoptionBody">
                    <tr><td colspan="10" class="text-center">加载中...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="cloudAdoptionPagination" class="pagination-wrap"></div>
    </div>
</div>

<script>
(function() {
    let caPage = 1;
    const caSize = 10;

    window.refreshCloudAdoptions = async function(page) {
        if (page) caPage = page;
        const tbody = document.getElementById('cloudAdoptionBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">加载中...</td></tr>';
        try {
            const params = { page: caPage, size: caSize };
            const statusVal = document.getElementById('caStatusFilter').value;
            if (statusVal) params.isActive = statusVal;

            const res = await ApiClient.request(API_ENDPOINTS.cloudAdoption.list, {
                method: 'GET',
                params: params
            });

            // ApiClient.request returns res.data when code===200
            const pageData = res;
            let records = [];

            if (pageData && pageData.records) {
                records = pageData.records;
            } else if (Array.isArray(pageData)) {
                records = pageData;
            }

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">暂无数据</td></tr>';
                return;
            }
            tbody.innerHTML = records.map(a => {
                const monthlyAmt = typeof a.monthlyAmount === 'number' ? a.monthlyAmount.toFixed(2) : (a.monthlyAmount || 0);
                const totalAmt = typeof a.totalAmount === 'number' ? a.totalAmount.toFixed(2) : (a.totalAmount || 0);
                return `<tr>
                    <td>${a.id}</td>
                    <td>${a.username || a.userId || '-'}</td>
                    <td>${a.catName || a.catId || '-'}</td>
                    <td>${a.adoptionName || '-'}</td>
                    <td>¥${monthlyAmt}</td>
                    <td>${a.startDate || '-'}</td>
                    <td>${a.endDate || '-'}</td>
                    <td><span class="badge ${a.isActive ? 'badge-success' : 'badge-secondary'}">${a.isActive ? '进行中' : '已结束'}</span></td>
                    <td>¥${totalAmt}</td>
                    <td>${(a.createTime || '').replace('T', ' ').substring(0, 16)}</td>
                </tr>`;
            }).join('');

            // Pagination
            const totalPages = pageData.pages || Math.ceil((pageData.total || 0) / caSize);
            const pagDiv = document.getElementById('cloudAdoptionPagination');
            pagDiv.innerHTML = '';
            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    pagDiv.innerHTML += `<button class="btn btn-sm ${i===caPage?'btn-primary':'btn-outline'}" onclick="refreshCloudAdoptions(${i})">${i}</button> `;
                }
            }
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center">加载失败: ${err.message}</td></tr>`;
        }
    };

    refreshCloudAdoptions();
})();
</script>
