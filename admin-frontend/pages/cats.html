<!-- Cat Management Page -->
<div class="page-container">
    <!-- Statistics Cards -->
    <div class="stats-grid" id="catStats">
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ±</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="totalCats">0</div>
                <div class="stat-card-label">æ€»çŒ«å’ªæ•°</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">âœ“</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="adoptableCats">0</div>
                <div class="stat-card-label">å¯é¢†å…»</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">â¤ï¸</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="adoptedCats">0</div>
                <div class="stat-card-label">å·²é¢†å…»</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">ğŸ¥</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="treatmentCats">0</div>
                <div class="stat-card-label">æ²»ç–—ä¸­</div>
            </div>
        </div>
    </div>

    <!-- Filters and Actions -->
    <div class="card">
        <div class="card-body">
            <div class="filter-row">
                <div class="filter-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢çŒ«å’ªåç§°ã€å“ç§ã€ä½ç½®...">
                    <select id="statusFilter" class="form-control">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="ADOPTABLE">å¯é¢†å…»</option>
                        <option value="ADOPTED">å·²é¢†å…»</option>
                        <option value="OBSERVATION">è§‚å¯Ÿä¸­</option>
                        <option value="TREATMENT">æ²»ç–—ä¸­</option>
                    </select>
                    <select id="genderFilter" class="form-control">
                        <option value="">å…¨éƒ¨æ€§åˆ«</option>
                        <option value="MALE">å…¬çŒ«</option>
                        <option value="FEMALE">æ¯çŒ«</option>
                    </select>
                    <button class="btn btn-primary" onclick="window.catPageHandlers.search()">æœç´¢</button>
                    <button class="btn btn-secondary" onclick="window.catPageHandlers.reset()">é‡ç½®</button>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-success" onclick="window.catPageHandlers.showCreateModal()">+ æ·»åŠ çŒ«å’ª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cat Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table class="table" id="catTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç…§ç‰‡</th>
                            <th>åç§°</th>
                            <th>å“ç§</th>
                            <th>æ€§åˆ«</th>
                            <th>å¹´é¾„</th>
                            <th>çŠ¶æ€</th>
                            <th>ä½ç½®</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="catTableBody">
                        <tr>
                            <td colspan="10" class="text-center">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-container" id="paginationContainer"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal" id="catModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-header">
            <h3 id="modalTitle">æ·»åŠ çŒ«å’ª</h3>
            <button class="modal-close" onclick="Modal.close('catModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="catForm">
                <input type="hidden" id="catId">
                <div class="form-row">
                    <div class="form-group">
                        <label>çŒ«å’ªåç§° *</label>
                        <input type="text" id="catName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>å“ç§ *</label>
                        <input type="text" id="catBreed" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ€§åˆ« *</label>
                        <select id="catGender" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="MALE">å…¬çŒ«</option>
                            <option value="FEMALE">æ¯çŒ«</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¹´é¾„ï¼ˆæœˆï¼‰*</label>
                        <input type="number" id="catAge" class="form-control" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>çŠ¶æ€ *</label>
                        <select id="catStatus" class="form-control" required>
                            <option value="ADOPTABLE">å¯é¢†å…»</option>
                            <option value="ADOPTED">å·²é¢†å…»</option>
                            <option value="OBSERVATION">è§‚å¯Ÿä¸­</option>
                            <option value="TREATMENT">æ²»ç–—ä¸­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä½ç½® *</label>
                        <input type="text" id="catLocation" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="catDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>ç…§ç‰‡URL</label>
                    <input type="text" id="catPhotoUrl" class="form-control" placeholder="http://...">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="Modal.close('catModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="window.catPageHandlers.saveCat()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
// Initialize page state
window.catPageState = window.catPageState || {
    currentPage: 1,
    pageSize: 10,
    filters: {}
};

// Page handlers
window.catPageHandlers = {
    async init() {
        await this.loadStatistics();
        await this.loadCats();
    },

    async loadStatistics() {
        try {
            const stats = await ApiClient.request(API_ENDPOINTS.cats.statistics);
            document.getElementById('totalCats').textContent = stats.total || 0;
            document.getElementById('adoptableCats').textContent = stats.adoptable || 0;
            document.getElementById('adoptedCats').textContent = stats.adopted || 0;
            document.getElementById('treatmentCats').textContent = stats.treatment || 0;
        } catch (error) {
            console.error('Load statistics error:', error);
        }
    },

    async loadCats() {
        try {
            Loading.show();
            const params = {
                page: window.catPageState.currentPage,
                size: window.catPageState.pageSize,
                ...window.catPageState.filters
            };

            const response = await ApiClient.request(API_ENDPOINTS.cats.list, {
                method: 'GET',
                params
            });

            this.renderTable(response.records || []);
            this.renderPagination(response.total || 0);
        } catch (error) {
            Toast.error('åŠ è½½çŒ«å’ªåˆ—è¡¨å¤±è´¥: ' + error.message);
            document.getElementById('catTableBody').innerHTML = `
                <tr><td colspan="10" class="text-center text-danger">åŠ è½½å¤±è´¥: ${error.message}</td></tr>
            `;
        } finally {
            Loading.hide();
        }
    },

    renderTable(cats) {
        const tbody = document.getElementById('catTableBody');
        if (cats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = cats.map(cat => `
            <tr>
                <td>${cat.id}</td>
                <td>
                    ${cat.photoUrl ? `<img src="${cat.photoUrl}" alt="${cat.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 'æ— ç…§ç‰‡'}
                </td>
                <td>${cat.name}</td>
                <td>${cat.breed || '-'}</td>
                <td>${cat.gender === 'MALE' ? 'å…¬çŒ«' : 'æ¯çŒ«'}</td>
                <td>${cat.age || 0}ä¸ªæœˆ</td>
                <td>
                    <span class="badge badge-${this.getStatusColor(cat.status)}">
                        ${this.getStatusText(cat.status)}
                    </span>
                </td>
                <td>${cat.location || '-'}</td>
                <td>${Utils.formatDate(cat.createTime)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="window.catPageHandlers.showEditModal(${cat.id})">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" onclick="window.catPageHandlers.deleteCat(${cat.id})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
    },

    renderPagination(total) {
        const totalPages = Math.ceil(total / window.catPageState.pageSize);
        const container = document.getElementById('paginationContainer');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = PaginationComponent.render(
            window.catPageState.currentPage,
            totalPages,
            total,
            (page) => {
                window.catPageState.currentPage = page;
                this.loadCats();
            }
        );
    },

    getStatusColor(status) {
        const colors = {
            'ADOPTABLE': 'success',
            'ADOPTED': 'info',
            'OBSERVATION': 'warning',
            'TREATMENT': 'danger'
        };
        return colors[status] || 'secondary';
    },

    getStatusText(status) {
        const texts = {
            'ADOPTABLE': 'å¯é¢†å…»',
            'ADOPTED': 'å·²é¢†å…»',
            'OBSERVATION': 'è§‚å¯Ÿä¸­',
            'TREATMENT': 'æ²»ç–—ä¸­'
        };
        return texts[status] || status;
    },

    search() {
        const keyword = document.getElementById('searchInput').value.trim();
        const status = document.getElementById('statusFilter').value;
        const gender = document.getElementById('genderFilter').value;

        window.catPageState.filters = {};
        if (keyword) window.catPageState.filters.keyword = keyword;
        if (status) window.catPageState.filters.status = status;
        if (gender) window.catPageState.filters.gender = gender;

        window.catPageState.currentPage = 1;
        this.loadCats();
    },

    reset() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('genderFilter').value = '';
        window.catPageState.filters = {};
        window.catPageState.currentPage = 1;
        this.loadCats();
    },

    showCreateModal() {
        document.getElementById('modalTitle').textContent = 'æ·»åŠ çŒ«å’ª';
        document.getElementById('catForm').reset();
        document.getElementById('catId').value = '';
        Modal.open('catModal');
    },

    async showEditModal(id) {
        try {
            Loading.show();
            const cat = await ApiClient.request(API_ENDPOINTS.cats.detail(id));

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘çŒ«å’ª';
            document.getElementById('catId').value = cat.id;
            document.getElementById('catName').value = cat.name;
            document.getElementById('catBreed').value = cat.breed || '';
            document.getElementById('catGender').value = cat.gender;
            document.getElementById('catAge').value = cat.age || 0;
            document.getElementById('catStatus').value = cat.status;
            document.getElementById('catLocation').value = cat.location || '';
            document.getElementById('catDescription').value = cat.description || '';
            document.getElementById('catPhotoUrl').value = cat.photoUrl || '';

            Modal.open('catModal');
        } catch (error) {
            Toast.error('åŠ è½½çŒ«å’ªä¿¡æ¯å¤±è´¥: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async saveCat() {
        const id = document.getElementById('catId').value;
        const data = {
            name: document.getElementById('catName').value.trim(),
            breed: document.getElementById('catBreed').value.trim(),
            gender: document.getElementById('catGender').value,
            age: parseInt(document.getElementById('catAge').value),
            status: document.getElementById('catStatus').value,
            location: document.getElementById('catLocation').value.trim(),
            description: document.getElementById('catDescription').value.trim(),
            photoUrl: document.getElementById('catPhotoUrl').value.trim()
        };

        if (!data.name || !data.breed || !data.gender || !data.status || !data.location) {
            Toast.warning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            return;
        }

        try {
            Loading.show();
            if (id) {
                await ApiClient.request(API_ENDPOINTS.cats.update(id), {
                    method: 'PUT',
                    body: data
                });
                Toast.success('æ›´æ–°æˆåŠŸ');
            } else {
                await ApiClient.request(API_ENDPOINTS.cats.create, {
                    method: 'POST',
                    body: data
                });
                Toast.success('æ·»åŠ æˆåŠŸ');
            }

            Modal.close('catModal');
            await this.loadStatistics();
            await this.loadCats();
        } catch (error) {
            Toast.error('ä¿å­˜å¤±è´¥: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async deleteCat(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™åªçŒ«å’ªå—ï¼Ÿ')) return;

        try {
            Loading.show();
            await ApiClient.request(API_ENDPOINTS.cats.delete(id), {
                method: 'DELETE'
            });
            Toast.success('åˆ é™¤æˆåŠŸ');
            await this.loadStatistics();
            await this.loadCats();
        } catch (error) {
            Toast.error('åˆ é™¤å¤±è´¥: ' + error.message);
        } finally {
            Loading.hide();
        }
    }
};

// Initialize page
window.catPageHandlers.init();
</script>
