<!-- Notifications Management Page -->
<div class="page-container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ””</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="totalNotifications">0</div>
                <div class="stat-card-label">æ€»é€šçŸ¥æ•°</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ“¤</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="sentNotifications">0</div>
                <div class="stat-card-label">å·²å‘é€</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">âœ“</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="readNotifications">0</div>
                <div class="stat-card-label">å·²è¯»</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">ğŸ“…</div>
            <div class="stat-card-content">
                <div class="stat-card-value" id="todayNotifications">0</div>
                <div class="stat-card-label">ä»Šæ—¥å‘é€</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="filter-row">
                <div class="filter-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢é€šçŸ¥æ ‡é¢˜ã€å†…å®¹...">
                    <select id="typeFilter" class="form-control">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="SYSTEM">ç³»ç»Ÿé€šçŸ¥</option>
                        <option value="ADOPTION">é¢†å…»é€šçŸ¥</option>
                        <option value="VERIFICATION">è®¤è¯é€šçŸ¥</option>
                        <option value="RESCUE">æ•‘åŠ©é€šçŸ¥</option>
                    </select>
                    <button class="btn btn-primary" onclick="window.notificationsPageHandlers.search()">æœç´¢</button>
                    <button class="btn btn-secondary" onclick="window.notificationsPageHandlers.reset()">é‡ç½®</button>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-success" onclick="window.notificationsPageHandlers.showCreateModal()">+ å‘é€é€šçŸ¥</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç±»å‹</th>
                            <th>æ ‡é¢˜</th>
                            <th>æ¥æ”¶è€…</th>
                            <th>çŠ¶æ€</th>
                            <th>å‘é€æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="notificationsTableBody">
                        <tr><td colspan="7" class="text-center">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-container" id="paginationContainer"></div>
        </div>
    </div>
</div>

<div class="modal" id="detailModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-header">
            <h3>é€šçŸ¥è¯¦æƒ…</h3>
            <button class="modal-close" onclick="Modal.close('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="Modal.close('detailModal')">å…³é—­</button>
        </div>
    </div>
</div>

<div class="modal" id="createModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>å‘é€é€šçŸ¥</h3>
            <button class="modal-close" onclick="Modal.close('createModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="notificationForm">
                <div class="form-group">
                    <label>é€šçŸ¥ç±»å‹ *</label>
                    <select id="notificationType" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="SYSTEM">ç³»ç»Ÿé€šçŸ¥</option>
                        <option value="ADOPTION">é¢†å…»é€šçŸ¥</option>
                        <option value="VERIFICATION">è®¤è¯é€šçŸ¥</option>
                        <option value="RESCUE">æ•‘åŠ©é€šçŸ¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜ *</label>
                    <input type="text" id="notificationTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>å†…å®¹ *</label>
                    <textarea id="notificationContent" class="form-control" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>æ¥æ”¶è€… *</label>
                    <select id="notificationTarget" class="form-control" required>
                        <option value="ALL">å…¨ä½“ç”¨æˆ·</option>
                        <option value="SPECIFIC">æŒ‡å®šç”¨æˆ·</option>
                    </select>
                </div>
                <div class="form-group" id="userIdGroup" style="display: none;">
                    <label>ç”¨æˆ·ID</label>
                    <input type="number" id="notificationUserId" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="Modal.close('createModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="window.notificationsPageHandlers.sendNotification()">å‘é€</button>
        </div>
    </div>
</div>

<script>
window.notificationsPageState = window.notificationsPageState || { currentPage: 1, pageSize: 10, filters: {} };

window.notificationsPageHandlers = {
    async init() {
        await this.loadStatistics();
        await this.loadNotifications();

        // Setup target change handler
        document.getElementById('notificationTarget').addEventListener('change', (e) => {
            document.getElementById('userIdGroup').style.display = e.target.value === 'SPECIFIC' ? 'block' : 'none';
        });
    },

    async loadStatistics() {
        try {
            const stats = await ApiClient.request(API_ENDPOINTS.notifications.statistics);
            document.getElementById('totalNotifications').textContent = stats.total || 0;
            document.getElementById('sentNotifications').textContent = stats.sent || 0;
            document.getElementById('readNotifications').textContent = stats.read || 0;
            document.getElementById('todayNotifications').textContent = stats.today || 0;
        } catch (error) {
            console.error('Load statistics error:', error);
        }
    },

    async loadNotifications() {
        try {
            Loading.show();
            const params = {
                page: window.notificationsPageState.currentPage,
                size: window.notificationsPageState.pageSize,
                ...window.notificationsPageState.filters
            };

            const response = await ApiClient.request(API_ENDPOINTS.notifications.list, {
                method: 'GET',
                params
            });

            this.renderTable(response.records || []);
            this.renderPagination(response.total || 0);
        } catch (error) {
            Toast.error('åŠ è½½é€šçŸ¥åˆ—è¡¨å¤±è´¥: ' + error.message);
            document.getElementById('notificationsTableBody').innerHTML = `
                <tr><td colspan="7" class="text-center text-danger">åŠ è½½å¤±è´¥: ${error.message}</td></tr>
            `;
        } finally {
            Loading.hide();
        }
    },

    renderTable(notifications) {
        const tbody = document.getElementById('notificationsTableBody');
        if (notifications.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = notifications.map(n => `
            <tr>
                <td>${n.id}</td>
                <td><span class="badge badge-${this.getTypeColor(n.type)}">${this.getTypeText(n.type)}</span></td>
                <td>${n.title || '-'}</td>
                <td>${n.receiverName || 'å…¨ä½“ç”¨æˆ·'}</td>
                <td><span class="badge badge-${n.isRead ? 'success' : 'warning'}">${n.isRead ? 'å·²è¯»' : 'æœªè¯»'}</span></td>
                <td>${Utils.formatDate(n.createTime)}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="window.notificationsPageHandlers.showDetail(${n.id})">è¯¦æƒ…</button>
                    <button class="btn btn-sm btn-danger" onclick="window.notificationsPageHandlers.deleteNotification(${n.id})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
    },

    renderPagination(total) {
        const totalPages = Math.ceil(total / window.notificationsPageState.pageSize);
        const container = document.getElementById('paginationContainer');
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = PaginationComponent.render(
            window.notificationsPageState.currentPage,
            totalPages,
            total,
            (page) => {
                window.notificationsPageState.currentPage = page;
                this.loadNotifications();
            }
        );
    },

    getTypeColor(type) {
        return { 'SYSTEM': 'primary', 'ADOPTION': 'success', 'VERIFICATION': 'info', 'RESCUE': 'warning' }[type] || 'secondary';
    },

    getTypeText(type) {
        return { 'SYSTEM': 'ç³»ç»Ÿé€šçŸ¥', 'ADOPTION': 'é¢†å…»é€šçŸ¥', 'VERIFICATION': 'è®¤è¯é€šçŸ¥', 'RESCUE': 'æ•‘åŠ©é€šçŸ¥' }[type] || type;
    },

    search() {
        const keyword = document.getElementById('searchInput').value.trim();
        const type = document.getElementById('typeFilter').value;
        window.notificationsPageState.filters = {};
        if (keyword) window.notificationsPageState.filters.keyword = keyword;
        if (type) window.notificationsPageState.filters.type = type;
        window.notificationsPageState.currentPage = 1;
        this.loadNotifications();
    },

    reset() {
        document.getElementById('searchInput').value = '';
        document.getElementById('typeFilter').value = '';
        window.notificationsPageState.filters = {};
        window.notificationsPageState.currentPage = 1;
        this.loadNotifications();
    },

    async showDetail(id) {
        try {
            Loading.show();
            const n = await ApiClient.request(API_ENDPOINTS.notifications.detail(id));
            document.getElementById('detailContent').innerHTML = `
                <div class="detail-section">
                    <h4>é€šçŸ¥ä¿¡æ¯</h4>
                    <div class="detail-row"><span class="detail-label">ç±»å‹:</span><span class="badge badge-${this.getTypeColor(n.type)}">${this.getTypeText(n.type)}</span></div>
                    <div class="detail-row"><span class="detail-label">æ ‡é¢˜:</span><span class="detail-value">${n.title || '-'}</span></div>
                    <div class="detail-row"><span class="detail-label">å†…å®¹:</span><span class="detail-value">${n.content || '-'}</span></div>
                    <div class="detail-row"><span class="detail-label">æ¥æ”¶è€…:</span><span class="detail-value">${n.receiverName || 'å…¨ä½“ç”¨æˆ·'}</span></div>
                    <div class="detail-row"><span class="detail-label">çŠ¶æ€:</span><span class="badge badge-${n.isRead ? 'success' : 'warning'}">${n.isRead ? 'å·²è¯»' : 'æœªè¯»'}</span></div>
                    <div class="detail-row"><span class="detail-label">å‘é€æ—¶é—´:</span><span class="detail-value">${Utils.formatDate(n.createTime)}</span></div>
                    ${n.readTime ? `<div class="detail-row"><span class="detail-label">è¯»å–æ—¶é—´:</span><span class="detail-value">${Utils.formatDate(n.readTime)}</span></div>` : ''}
                </div>
            `;
            Modal.open('detailModal');
        } catch (error) {
            Toast.error('åŠ è½½è¯¦æƒ…å¤±ï¿½ï¿½ï¿½: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    showCreateModal() {
        document.getElementById('notificationForm').reset();
        document.getElementById('userIdGroup').style.display = 'none';
        Modal.open('createModal');
    },

    async sendNotification() {
        const type = document.getElementById('notificationType').value;
        const title = document.getElementById('notificationTitle').value.trim();
        const content = document.getElementById('notificationContent').value.trim();
        const target = document.getElementById('notificationTarget').value;
        const userId = document.getElementById('notificationUserId').value;

        if (!type || !title || !content || !target) {
            Toast.warning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
            return;
        }

        if (target === 'SPECIFIC' && !userId) {
            Toast.warning('è¯·è¾“å…¥ç”¨æˆ·ID');
            return;
        }

        try {
            Loading.show();
            const data = { type, title, content };
            if (target === 'SPECIFIC') {
                data.userId = parseInt(userId);
            }

            await ApiClient.request(API_ENDPOINTS.notifications.send, {
                method: 'POST',
                body: data
            });

            Toast.success('å‘é€æˆåŠŸ');
            Modal.close('createModal');
            await this.loadStatistics();
            await this.loadNotifications();
        } catch (error) {
            Toast.error('å‘é€å¤±è´¥: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async deleteNotification(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šçŸ¥å—ï¼Ÿ')) return;

        try {
            Loading.show();
            await ApiClient.request(API_ENDPOINTS.notifications.delete(id), {
                method: 'DELETE'
            });
            Toast.success('åˆ é™¤æˆåŠŸ');
            await this.loadStatistics();
            await this.loadNotifications();
        } catch (error) {
            Toast.error('åˆ é™¤å¤±è´¥: ' + error.message);
        } finally {
            Loading.hide();
        }
    }
};

window.notificationsPageHandlers.init();
</script>
