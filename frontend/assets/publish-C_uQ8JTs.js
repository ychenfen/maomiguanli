import{g as q}from"./index-C7QMbvNI.js";/* empty css                *//* empty css                     *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                    *//* empty css                 *//* empty css                       *//* empty css                        */import{r as p,l as F,z as V,B as u,R as t,J as l,aA as $,A as v,O as i,u as h,Q as J,a6 as Y,I as j,P as w}from"./vue-vendor-L7KxampG.js";import{O as G,q as H,r as Q,D as W,M as X,u as K,a9 as Z,k as ee,aa as te,I as le,J as oe,a as ae,ab as se,m as ne,e as re,E as m}from"./element-plus-o-j_G_-z.js";import{p as ie}from"./community-B9PPt_GH.js";import{g as de}from"./cat-DwVSNbqL.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-CCXpdI6d.js";const pe={class:"publish-page"},me={class:"container-small"},ce={class:"card-header"},fe={class:"cat-option"},_e={__name:"publish",setup(ge){const x=$(),b=p(null),c=p(!1),o=F({type:"DAILY",title:"",content:"",images:[],catId:null}),k={type:[{required:!0,message:"请选择动态类型",trigger:"change"}],content:[{required:!0,message:"请输入动态内容",trigger:"blur"},{min:10,message:"内容至少10个字符",trigger:"blur"}]},y=p([]),B="/api/files/upload/image",U={Authorization:`Bearer ${q()}`},f=p(!1),_=p([]),R=s=>{const e=s.type.startsWith("image/"),n=s.size/1024/1024<5;return e?n?!0:(m.error("图片大小不能超过 5MB"),!1):(m.error("只能上传图片文件"),!1)},z=(s,e,n)=>{if(s.code===200)o.images.push(s.data.url);else{m.error("上传失败");const r=n.findIndex(g=>g.uid===e.uid);r>-1&&n.splice(r,1)}},C=(s,e)=>{if(s.response&&s.response.code===200){const n=s.response.data.url,r=o.images.indexOf(n);r>-1&&o.images.splice(r,1)}},L=async s=>{if(!s){_.value=[];return}f.value=!0;try{const e=await de({keyword:s,page:1,size:20});e.code===200&&(_.value=e.data.records||[])}catch(e){console.error("搜索猫咪失败",e)}finally{f.value=!1}},A=async()=>{if(await b.value.validate().catch(()=>!1)){c.value=!0;try{const e={type:o.type,title:o.title||void 0,content:o.content,images:o.images.length>0?o.images:void 0,catId:o.catId||void 0};(await ie(e)).code===200&&(m.success("发布成功"),x.push("/community"))}catch(e){m.error(e.message||"发布失败")}finally{c.value=!1}}};return(s,e)=>{const n=re,r=X,g=W,d=Q,E=K,I=ee,O=Z,D=ae,M=ne,N=oe,S=le,P=H,T=G;return v(),V("div",pe,[u("div",me,[t(T,null,{header:l(()=>[u("div",ce,[e[7]||(e[7]=u("h2",null,"发布动态",-1)),t(n,{onClick:e[0]||(e[0]=a=>s.$router.back())},{default:l(()=>[...e[6]||(e[6]=[i("返回",-1)])]),_:1})])]),default:l(()=>[t(P,{ref_key:"formRef",ref:b,model:o,rules:k,"label-width":"100px","label-position":"top"},{default:l(()=>[t(d,{label:"动态类型",prop:"type"},{default:l(()=>[t(g,{modelValue:o.type,"onUpdate:modelValue":e[1]||(e[1]=a=>o.type=a),size:"large"},{default:l(()=>[t(r,{label:"ADOPTION"},{default:l(()=>[...e[8]||(e[8]=[i("领养分享",-1)])]),_:1}),t(r,{label:"DAILY"},{default:l(()=>[...e[9]||(e[9]=[i("日常记录",-1)])]),_:1}),t(r,{label:"RESCUE"},{default:l(()=>[...e[10]||(e[10]=[i("救助故事",-1)])]),_:1}),t(r,{label:"EXPERIENCE"},{default:l(()=>[...e[11]||(e[11]=[i("养猫经验",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(d,{label:"标题（选填）",prop:"title"},{default:l(()=>[t(E,{modelValue:o.title,"onUpdate:modelValue":e[2]||(e[2]=a=>o.title=a),placeholder:"给你的动态起个标题吧（可选）",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(d,{label:"内容",prop:"content"},{default:l(()=>[t(E,{modelValue:o.content,"onUpdate:modelValue":e[3]||(e[3]=a=>o.content=a),type:"textarea",rows:10,placeholder:"分享你和猫咪的故事...",maxlength:"2000","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(d,{label:"图片（最多9张）"},{default:l(()=>[t(O,{"file-list":y.value,"onUpdate:fileList":e[4]||(e[4]=a=>y.value=a),action:B,headers:U,"list-type":"picture-card",limit:9,"on-success":z,"on-remove":C,"before-upload":R},{default:l(()=>[t(I,null,{default:l(()=>[t(h(te))]),_:1})]),_:1},8,["file-list"]),e[12]||(e[12]=u("div",{class:"upload-tip"},"支持jpg、png、gif格式，单张图片不超过5MB",-1))]),_:1}),t(d,{label:"关联猫咪（选填）"},{default:l(()=>[t(S,{modelValue:o.catId,"onUpdate:modelValue":e[5]||(e[5]=a=>o.catId=a),placeholder:"选择要关联的猫咪",clearable:"",filterable:"",remote:"","remote-method":L,loading:f.value,style:{width:"100%"}},{default:l(()=>[(v(!0),V(J,null,Y(_.value,a=>(v(),j(N,{key:a.id,label:a.name,value:a.id},{default:l(()=>[u("div",fe,[t(D,{size:32,src:a.coverImage,shape:"square"},{default:l(()=>[t(I,null,{default:l(()=>[t(h(se))]),_:1})]),_:1},8,["src"]),u("span",null,w(a.name),1),t(M,{size:"small",type:"info"},{default:l(()=>[i(w(a.breed),1)]),_:2},1024)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),t(d,null,{default:l(()=>[t(n,{type:"primary",size:"large",loading:c.value,onClick:A,style:{width:"100%"}},{default:l(()=>[...e[13]||(e[13]=[i(" 发布动态 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})])])}}},Ae=ue(_e,[["__scopeId","data-v-2b09f3d8"]]);export{Ae as default};
