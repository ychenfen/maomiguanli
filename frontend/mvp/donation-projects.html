<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æçŒ®é¡¹ç›® - æ ¡å›­çŒ«å’ªæ•‘åŠ©</title>
  <link rel="stylesheet" href="/mvp/mvp.css" />
  <script src="/config.js"></script>
  <script src="/mvp/mvp.js"></script>
</head>
<body>
  <div id="nav"></div>
  <div class="container">
    <div class="page-header">
      <h1>æçŒ®é¡¹ç›®</h1>
      <p>æµè§ˆæ­£åœ¨è¿›è¡Œçš„ä¼—ç­¹é¡¹ç›®ï¼Œä¸ºæµæµªçŒ«çš„åŒ»ç–—ã€ç»è‚²ã€æ•‘åŠ©è´¡çŒ®ä¸€ä»½åŠ›é‡</p>
    </div>
    <div class="grid grid-2" id="projectList">
      <div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>
    </div>
    <div id="pagination"></div>
  </div>
  <script>
    document.getElementById('nav').innerHTML = MVP.renderNav('donate-list');
    let currentPage = 1;
    const pageSize = 8;

    async function loadProjects(page) {
      currentPage = page;
      const container = document.getElementById('projectList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
      try {
        const res = await MVP.apiGet('/crowdfunding/page', { page, size: pageSize });
        if (res.code !== 200) { container.innerHTML = '<div class="empty"><p>åŠ è½½å¤±è´¥</p></div>'; return; }
        const records = res.data.records || [];
        const total = res.data.total || 0;
        const totalPages = Math.ceil(total / pageSize);
        if (records.length === 0) {
          container.innerHTML = '<div class="empty"><div class="icon">ğŸ“‹</div><p>æš‚æ— ä¼—ç­¹é¡¹ç›®</p></div>';
          return;
        }
        container.innerHTML = records.map(p => {
          const progress = p.progress || (p.targetAmount > 0 ? Math.round(p.currentAmount / p.targetAmount * 100) : 0);
          const statusClass = p.status === 'ACTIVE' ? 'badge-active' : p.status === 'COMPLETED' ? 'badge-completed' : 'badge-cancelled';
          const statusText = p.statusText || p.status;
          return `
          <div class="item-card" onclick="window.location.href='/mvp/donation-detail.html?id=${p.id}'">
            <img class="cover" src="${MVP.catImg(p.coverImage || p.catCoverImage)}" alt="${p.title}" onerror="this.style.background='#edf2f7'" />
            <div class="info">
              <h3>${p.title}</h3>
              <div class="meta">
                <span>å‘èµ·äºº: ${p.creatorName || '-'}</span>
                <span class="badge ${statusClass}">${statusText}</span>
              </div>
              ${p.catName ? `<div class="meta" style="margin-top:4px;"><span>å…³è”çŒ«å’ª: ${p.catName}</span></div>` : ''}
              <div class="progress-bar" style="margin-top:10px;">
                <div class="fill" style="width:${Math.min(progress, 100)}%"></div>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:13px;">
                <span style="color:var(--primary);font-weight:600;">Â¥${MVP.fmtMoney(p.currentAmount)} / Â¥${MVP.fmtMoney(p.targetAmount)}</span>
                <span style="color:var(--text-secondary);">${progress}%</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--text-secondary);">
                <span>${p.supporterCount || 0} äººæ”¯æŒ</span>
                <span>${p.remainingDays != null ? p.remainingDays + ' å¤©å‰©ä½™' : ''}</span>
              </div>
              <div style="margin-top:10px;">
                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();window.location.href='/mvp/donation-new.html?crowdfundingId=${p.id}&title=${encodeURIComponent(p.title)}'">ç«‹å³æçŒ®</button>
              </div>
            </div>
          </div>`;
        }).join('');
        const pagDiv = document.getElementById('pagination');
        pagDiv.innerHTML = '';
        if (totalPages > 1) pagDiv.appendChild(MVP.renderPagination(currentPage, totalPages, loadProjects));
      } catch (err) {
        container.innerHTML = `<div class="empty"><p>åŠ è½½å¤±è´¥: ${err.message}</p></div>`;
      }
    }
    loadProjects(1);
  </script>
</body>
</html>
