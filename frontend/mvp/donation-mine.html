<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æçŒ® - æ ¡å›­çŒ«å’ªæ•‘åŠ©</title>
  <link rel="stylesheet" href="/mvp/mvp.css" />
  <script src="/config.js"></script>
  <script src="/mvp/mvp.js"></script>
</head>
<body>
  <div id="nav"></div>
  <div class="container">
    <div class="page-header">
      <h1>æˆ‘çš„æçŒ®/æ‰“èµ</h1>
      <p>æŸ¥çœ‹ä½ çš„æ‰€æœ‰æçŒ®å’Œæ‰“èµè®°å½•</p>
    </div>
    <div class="stats-row">
      <div class="stat-box"><div class="num" id="statCount">-</div><div class="label">æçŒ®æ¬¡æ•°</div></div>
      <div class="stat-box"><div class="num" id="statTotal">-</div><div class="label">ç´¯è®¡é‡‘é¢</div></div>
    </div>
    <div id="listContainer"><div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div></div>
    <div id="pagination"></div>
  </div>
  <script>
    document.getElementById('nav').innerHTML = MVP.renderNav('donate-mine');
    let currentPage = 1;
    const pageSize = 10;

    async function loadDonations(page) {
      if (!MVP.requireLogin()) return;
      currentPage = page;
      const container = document.getElementById('listContainer');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
      try {
        const res = await MVP.apiGet('/donation/my-donations', { page, size: pageSize });
        if (res.code !== 200) { container.innerHTML = '<div class="empty"><p>åŠ è½½å¤±è´¥</p></div>'; return; }

        // å¯èƒ½è¿”å›æ•°ç»„æˆ–åˆ†é¡µå¯¹è±¡
        let list, total;
        if (Array.isArray(res.data)) {
          list = res.data;
          total = list.length;
        } else if (res.data && res.data.records) {
          list = res.data.records;
          total = res.data.total || list.length;
        } else {
          list = [];
          total = 0;
        }

        // ç»Ÿè®¡
        let totalAmount = 0;
        list.forEach(d => { totalAmount += Number(d.amount) || 0; });
        document.getElementById('statCount').textContent = total;
        document.getElementById('statTotal').textContent = 'Â¥' + MVP.fmtMoney(totalAmount);

        if (list.length === 0) {
          container.innerHTML = '<div class="empty"><div class="icon">ğŸ’</div><p>ä½ è¿˜æ²¡æœ‰æçŒ®è®°å½•</p><div style="margin-top:12px;display:flex;gap:10px;justify-content:center;"><a href="/mvp/donation-projects.html" class="btn btn-primary btn-sm">å»æçŒ®</a><a href="/mvp/tip.html" class="btn btn-success btn-sm">å»æ‰“èµ</a></div></div>';
          return;
        }

        container.innerHTML = `<div class="table-wrap"><table>
          <thead><tr><th>ç±»å‹</th><th>ç›®æ ‡</th><th>é‡‘é¢</th><th>ç•™è¨€</th><th>æ”¯ä»˜æ–¹å¼</th><th>çŠ¶æ€</th><th>æ—¶é—´</th></tr></thead>
          <tbody>${list.map(d => {
            const type = d.crowdfundingId ? 'é¡¹ç›®æçŒ®' : (d.catId ? 'çŒ«å’ªæ‰“èµ' : 'æçŒ®');
            const target = d.crowdfundingTitle || d.catName || '-';
            const statusClass = d.status === 'COMPLETED' ? 'badge-completed' : d.status === 'PENDING' ? 'badge-pending' : 'badge-active';
            return `<tr>
              <td><span class="badge ${d.crowdfundingId ? 'badge-active' : 'badge-completed'}">${type}</span></td>
              <td>${target}</td>
              <td style="color:var(--warning);font-weight:600;">Â¥${MVP.fmtMoney(d.amount)}</td>
              <td>${d.message || '-'}</td>
              <td>${d.paymentMethod || '-'}</td>
              <td><span class="badge ${statusClass}">${d.statusText || d.status || '-'}</span></td>
              <td>${MVP.fmtDate(d.createTime)}</td>
            </tr>`;
          }).join('')}</tbody></table></div>`;

        // Pagination
        if (!Array.isArray(res.data) && res.data.pages > 1) {
          const pagDiv = document.getElementById('pagination');
          pagDiv.innerHTML = '';
          pagDiv.appendChild(MVP.renderPagination(currentPage, res.data.pages, loadDonations));
        }
      } catch (err) {
        container.innerHTML = `<div class="empty"><p>åŠ è½½å¤±è´¥: ${err.message}</p></div>`;
      }
    }
    loadDonations(1);
  </script>
</body>
</html>
