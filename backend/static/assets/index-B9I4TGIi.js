import{s as y,_ as ne}from"./index-59OIMCbR.js";/* empty css                   *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css               *//* empty css                */import{r as i,o as de,B as N,E as s,C as l,M as K,D as a,y as _,az as ie,z as m,Q as u,R as c,u as P,O as ue,K as re,a5 as me}from"./vue-vendor-UlW9XFxV.js";import{g as ce}from"./cat-CoDgQuJ0.js";import{e as pe,y as ve,a6 as fe,R as _e,Y as ye,E as v,X as ge,m as we,ar as be,as as ke,_ as Ce,B as he,F as Ve,H as xe,S as Ee,T as Ae,I as Ie,ap as Ne,a5 as $e}from"./element-plus-5e6ZgU0u.js";import"./utils-Yxd-MeZx.js";function Le(){return y({url:"/cloud-adoption/my-adoptions",method:"get"})}function Re(p){return y({url:"/cloud-adoption",method:"post",data:p})}function Se(p){return y({url:`/cloud-adoption/${p}/cancel`,method:"put"})}function Be(p,V){return y({url:`/cloud-adoption/${p}/renew`,method:"put",params:{months:V}})}function Ue(){return y({url:"/cloud-adoption/stats",method:"get"})}function Fe(p){return y({url:"/cloud-adoption/check-cat-adopted",method:"get",params:{catId:p}})}const Me={class:"cloud-adoption-page"},Te={class:"container"},De={class:"page-header"},ze={class:"stat-num"},Oe={class:"stat-num"},qe={class:"stat-num"},He={class:"card-header"},Ke=["onClick"],Pe={class:"meta"},Qe={class:"name"},Xe={class:"sub"},Ye={key:0,class:"expired"},je={key:1},Ge={__name:"index",setup(p){const V=ie(),x=i(!1),$=i(!1),E=i([]),g=i({}),Q=async()=>{$.value=!0;try{const o=await Ue();o.code===200&&(g.value=o.data||{})}catch{g.value={}}finally{$.value=!1}},X=async()=>{x.value=!0;try{const o=await Le();o.code===200&&(E.value=Array.isArray(o.data)?o.data:[])}catch{E.value=[],v.error("加载云养列表失败")}finally{x.value=!1}},w=async()=>{await Promise.all([Q(),X()])},b=i(!1),L=i(!1),F=i(null),d=i({catId:null,adoptionName:"",monthlyAmount:10,message:""}),Y={catId:[{required:!0,message:"请选择猫咪",trigger:"change"}],adoptionName:[{required:!0,message:"请输入云养名称",trigger:"blur"}],monthlyAmount:[{required:!0,message:"请输入每月金额",trigger:"change"}]},R=i(!1),k=i([]),j=async o=>{const e=(o||"").trim();if(!e){k.value=[];return}R.value=!0;try{const n=await ce({pageNum:1,pageSize:20,keyword:e,adoptableOnly:!0});n.code===200&&(k.value=n.data.records||[])}catch{k.value=[]}finally{R.value=!1}},M=()=>{d.value={catId:null,adoptionName:"",monthlyAmount:10,message:""},k.value=[],b.value=!0},G=async()=>{var e,n;if(await((n=(e=F.value)==null?void 0:e.validate)==null?void 0:n.call(e).catch(()=>!1))){L.value=!0;try{const r=await Fe(d.value.catId);if(r.code===200&&r.data===!0){v.warning("你已经在云养这只猫咪啦");return}(await Re({catId:d.value.catId,adoptionName:d.value.adoptionName,monthlyAmount:d.value.monthlyAmount,message:d.value.message||""})).code===200&&(v.success("创建成功"),b.value=!1,await w())}catch(r){v.error((r==null?void 0:r.message)||"创建失败")}finally{L.value=!1}}},C=i(!1),S=i(!1),A=i(1),B=i(null),J=o=>{B.value=o,A.value=1,C.value=!0},W=async()=>{if(B.value){S.value=!0;try{(await Be(B.value.id,A.value)).code===200&&(v.success("续费成功"),C.value=!1,await w())}catch(o){v.error((o==null?void 0:o.message)||"续费失败")}finally{S.value=!1}}},Z=async o=>{try{await $e.confirm(`确定要取消对「${o.catName||"猫咪"}」的云养吗？`,"提示",{type:"warning"}),(await Se(o.id)).code===200&&(v.success("已取消"),await w())}catch{}};return de(()=>{w()}),(o,e)=>{const n=pe,r=ye,I=ge,ee=_e,te=we,ae=Ce,f=ke,T=he,le=be,oe=Ae,se=Ee,h=xe,D=Ie,z=Ne,O=Ve,q=fe,H=ve;return m(),N("div",Me,[s("div",Te,[s("div",De,[e[10]||(e[10]=s("div",null,[s("h1",null,"云养计划"),s("p",{class:"desc"},"用每月一杯奶茶钱，持续支持校园猫咪的医疗与口粮。")],-1)),l(n,{type:"primary",onClick:M},{default:a(()=>[...e[9]||(e[9]=[u("开始云养",-1)])]),_:1})]),K((m(),_(ee,{gutter:16,class:"stats-row"},{default:a(()=>[l(I,{xs:24,sm:8},{default:a(()=>[l(r,{class:"stat-card",shadow:"never"},{default:a(()=>[s("div",ze,c(g.value.activeCount??"-"),1),e[11]||(e[11]=s("div",{class:"stat-label"},"活跃云养",-1))]),_:1})]),_:1}),l(I,{xs:24,sm:8},{default:a(()=>[l(r,{class:"stat-card",shadow:"never"},{default:a(()=>[s("div",Oe,"¥"+c(g.value.totalAmount??"-"),1),e[12]||(e[12]=s("div",{class:"stat-label"},"累计云养金额",-1))]),_:1})]),_:1}),l(I,{xs:24,sm:8},{default:a(()=>[l(r,{class:"stat-card",shadow:"never"},{default:a(()=>[s("div",qe,c(g.value.expiringSoonCount??"-"),1),e[13]||(e[13]=s("div",{class:"stat-label"},"即将到期",-1))]),_:1})]),_:1})]),_:1})),[[H,$.value]]),K((m(),_(r,{class:"list-card"},{header:a(()=>[s("div",He,[e[15]||(e[15]=s("span",null,"我的云养",-1)),l(n,{link:"",type:"primary",onClick:w},{default:a(()=>[...e[14]||(e[14]=[u("刷新",-1)])]),_:1})])]),default:a(()=>[!x.value&&E.value.length===0?(m(),_(te,{key:0,description:"暂无云养记录"},{default:a(()=>[l(n,{type:"primary",onClick:M},{default:a(()=>[...e[16]||(e[16]=[u("开始云养",-1)])]),_:1})]),_:1})):(m(),_(le,{key:1,data:E.value,style:{width:"100%"}},{default:a(()=>[l(f,{label:"猫咪","min-width":"220"},{default:a(({row:t})=>[s("div",{class:"cat-cell",onClick:U=>P(V).push(`/cats/${t.catId}`)},[l(ae,{class:"cover",src:t.catCoverImage,fit:"cover"},null,8,["src"]),s("div",Pe,[s("div",Qe,c(t.catName||"-"),1),s("div",Xe,"云养名："+c(t.adoptionName||"-"),1)])],8,Ke)]),_:1}),l(f,{label:"每月金额",width:"120"},{default:a(({row:t})=>[u("¥"+c(t.monthlyAmount),1)]),_:1}),l(f,{label:"累计",width:"120"},{default:a(({row:t})=>[u("¥"+c(t.totalAmount??0),1)]),_:1}),l(f,{label:"剩余",width:"120"},{default:a(({row:t})=>[t.isExpired?(m(),N("span",Ye,"已过期")):(m(),N("span",je,c(t.remainingDays??"-")+" 天",1)),t.isExpiringSoon&&!t.isExpired?(m(),_(T,{key:2,size:"small",type:"warning",style:{"margin-left":"8px"}},{default:a(()=>[...e[17]||(e[17]=[u(" 即将到期 ",-1)])]),_:1})):ue("",!0)]),_:1}),l(f,{label:"状态",width:"120"},{default:a(({row:t})=>[l(T,{type:t.isActive?"success":"info"},{default:a(()=>[u(c(t.isActive?"活跃":"已取消"),1)]),_:2},1032,["type"])]),_:1}),l(f,{label:"操作",width:"220",fixed:"right"},{default:a(({row:t})=>[l(n,{link:"",type:"primary",onClick:U=>P(V).push(`/cats/${t.catId}`)},{default:a(()=>[...e[18]||(e[18]=[u("看猫咪",-1)])]),_:1},8,["onClick"]),l(n,{link:"",type:"success",disabled:!t.isActive,onClick:U=>J(t)},{default:a(()=>[...e[19]||(e[19]=[u("续费",-1)])]),_:1},8,["disabled","onClick"]),l(n,{link:"",type:"danger",disabled:!t.isActive,onClick:U=>Z(t)},{default:a(()=>[...e[20]||(e[20]=[u("取消",-1)])]),_:1},8,["disabled","onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})),[[H,x.value]])]),l(q,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=t=>b.value=t),title:"开始云养",width:"520px"},{footer:a(()=>[l(n,{onClick:e[4]||(e[4]=t=>b.value=!1)},{default:a(()=>[...e[21]||(e[21]=[u("取消",-1)])]),_:1}),l(n,{type:"primary",loading:L.value,onClick:G},{default:a(()=>[...e[22]||(e[22]=[u("确认",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(O,{ref_key:"createFormRef",ref:F,model:d.value,rules:Y,"label-width":"90px"},{default:a(()=>[l(h,{label:"选择猫咪",prop:"catId"},{default:a(()=>[l(se,{modelValue:d.value.catId,"onUpdate:modelValue":e[0]||(e[0]=t=>d.value.catId=t),filterable:"",remote:"","reserve-keyword":"","remote-method":j,loading:R.value,placeholder:"输入关键词搜索猫咪",style:{width:"100%"}},{default:a(()=>[(m(!0),N(re,null,me(k.value,t=>(m(),_(oe,{key:t.id,label:`${t.name}（${t.breed||"未知"}）`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),l(h,{label:"云养名称",prop:"adoptionName"},{default:a(()=>[l(D,{modelValue:d.value.adoptionName,"onUpdate:modelValue":e[1]||(e[1]=t=>d.value.adoptionName=t),maxlength:"30",placeholder:"给这段关系起个名字"},null,8,["modelValue"])]),_:1}),l(h,{label:"每月金额",prop:"monthlyAmount"},{default:a(()=>[l(z,{modelValue:d.value.monthlyAmount,"onUpdate:modelValue":e[2]||(e[2]=t=>d.value.monthlyAmount=t),min:1,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(h,{label:"寄语",prop:"message"},{default:a(()=>[l(D,{modelValue:d.value.message,"onUpdate:modelValue":e[3]||(e[3]=t=>d.value.message=t),type:"textarea",rows:3,maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(q,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=t=>C.value=t),title:"续费云养",width:"420px"},{footer:a(()=>[l(n,{onClick:e[7]||(e[7]=t=>C.value=!1)},{default:a(()=>[...e[23]||(e[23]=[u("取消",-1)])]),_:1}),l(n,{type:"primary",loading:S.value,onClick:W},{default:a(()=>[...e[24]||(e[24]=[u("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(O,{"label-width":"90px"},{default:a(()=>[l(h,{label:"续费月数"},{default:a(()=>[l(z,{modelValue:A.value,"onUpdate:modelValue":e[6]||(e[6]=t=>A.value=t),min:1,max:24,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},_t=ne(Ge,[["__scopeId","data-v-99299238"]]);export{_t as default};
