import{_ as ve,u as _e,g as ge,b as we,c as H,d as ye}from"./index-59OIMCbR.js";/* empty css                   *//* empty css                  *//* empty css                   *//* empty css                  *//* empty css                    *//* empty css               *//* empty css                    *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                 *//* empty css                     *//* empty css                *//* empty css                   */import{r as m,l as $,w as be,o as he,B as v,E as o,C as a,D as l,az as Ve,z as d,M as Q,y as M,u as h,O as U,R as _,Q as R,K as Pe,a5 as Ue}from"./vue-vendor-UlW9XFxV.js";import{R as Ee,a6 as Ie,E as c,X as ke,Y as Ce,r as Ne,l as ze,J as Ae,e as Me,az as Re,B as xe,ae as De,aA as Te,N as Be,O as $e,ah as Fe,y as Se,at as Le,au as Oe,F as Ye,H as qe,I as je,m as He,Q as Qe,a9 as Je,aa as Ke,a as We}from"./element-plus-5e6ZgU0u.js";import{g as Xe}from"./adoption-Cb5HDKbY.js";import{b as Ge}from"./rescue-BHuK3UKq.js";import{i as Ze}from"./community-C3gF1jKv.js";import{b as ea}from"./cat-CoDgQuJ0.js";import{g as aa}from"./favorites-RBzN3m0r.js";import{C as la}from"./index-BCm8nuFM.js";import"./utils-Yxd-MeZx.js";/* empty css                        */const sa={class:"profile-page"},ta={class:"container"},oa={class:"profile-header"},ra={class:"profile-info"},na={key:0,class:"real-name"},da={class:"profile-details"},ia={key:0,class:"detail-item"},ua={key:1,class:"detail-item"},ma={key:2,class:"detail-item"},pa={class:"detail-item"},ca={class:"profile-stats"},fa={class:"stat-number"},va={class:"stat-number"},_a={class:"stat-number"},ga={class:"favorites-list"},wa={key:1,class:"cats-grid"},ya={key:2,class:"pagination-wrapper"},ba=["src"],ha={__name:"profile",setup(Va){const J=Ve(),E=_e(),x=m(!1),V=m(!1),I=m(!1),k=m("basic"),n=m({}),C=m({}),F=m(null),i=$({username:"",realName:"",studentId:"",phone:"",email:""}),K={realName:[{max:50,message:"真实姓名不能超过50个字符",trigger:"blur"}],studentId:[{max:20,message:"学号/工号不能超过20个字符",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}]},S=m(null),u=$({oldPassword:"",newPassword:"",confirmPassword:""}),W={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"密码长度为6-20位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:(s,e,r)=>{e!==u.newPassword?r(new Error("两次输入的密码不一致")):r()},trigger:"blur"}]},N=m([]),D=m(0),b=$({page:1,size:12}),P=m(!1),z=m(""),X="https://your-domain.com/api/files/upload/image",G={Authorization:`Bearer ${ge()}`},T=async()=>{x.value=!0;try{const s=await we();s.code===200&&(n.value=s.data,Object.assign(i,{username:s.data.username,realName:s.data.realName||"",studentId:s.data.studentId||"",phone:s.data.phone||"",email:s.data.email||""}),await Z())}catch{c.error("加载用户信息失败")}finally{x.value=!1}},Z=async()=>{var s,e;try{const r=((s=n.value)==null?void 0:s.id)||((e=E.userInfo)==null?void 0:e.id);if(!r)return;const[w,p,g]=await Promise.all([Xe(),Ge(),Ze(r)]);C.value={applications:Array.isArray(w==null?void 0:w.data)?w.data.length:0,rescues:Array.isArray(p==null?void 0:p.data)?p.data.length:0,dynamics:Array.isArray(g==null?void 0:g.data)?g.data.length:0}}catch(r){console.error("加载用户统计失败",r)}},ee=async()=>{if(await F.value.validate().catch(()=>!1)){V.value=!0;try{(await H(i)).code===200&&(c.success("保存成功"),await E.getUserInfo(),await T())}catch(e){c.error(e.message||"保存失败")}finally{V.value=!1}}},ae=async()=>{if(await S.value.validate().catch(()=>!1)){V.value=!0;try{(await ye({oldPassword:u.oldPassword,newPassword:u.newPassword})).code===200&&(c.success("密码修改成功，请重新登录"),u.oldPassword="",u.newPassword="",u.confirmPassword="",setTimeout(()=>{E.logout(),J.push("/login")},1500))}catch(e){c.error(e.message||"修改密码失败")}finally{V.value=!1}}},L=async()=>{I.value=!0;try{const s=aa();D.value=s.length;const e=(b.page-1)*b.size,r=s.slice(e,e+b.size),w=await Promise.all(r.map(p=>ea(p).then(g=>g.code===200?g.data:null).catch(()=>null)));N.value=w.filter(Boolean)}catch{c.error("加载收藏列表失败")}finally{I.value=!1}},le=()=>{z.value=n.value.avatar||"",P.value=!0},se=s=>{const e=s.type.startsWith("image/"),r=s.size/1024/1024<2;return e?r?!0:(c.error("图片大小不能超过 2MB"),!1):(c.error("只能上传图片文件"),!1)},te=async s=>{if(s.code===200){z.value=s.data.fileUrl;try{(await H({avatar:s.data.fileUrl})).code===200&&(c.success("头像更新成功"),P.value=!1,await E.getUserInfo(),await T())}catch{c.error("更新头像失败")}}else c.error("上传失败")},oe=s=>({USER:"普通用户",VOLUNTEER:"志愿者",ADMIN:"管理员",SUPER_ADMIN:"超级管理员"})[s]||s,re=s=>({USER:"info",VOLUNTEER:"success",ADMIN:"warning",SUPER_ADMIN:"danger"})[s]||"info",ne=s=>s?We(s).format("YYYY-MM-DD"):"-",de=()=>{k.value==="favorites"&&N.value.length===0&&L()};return be(k,()=>{de()}),he(()=>{T()}),(s,e)=>{const r=ze,w=Ne,p=Me,g=xe,O=De,A=Ce,Y=ke,y=je,f=qe,q=Ye,B=Oe,ie=He,ue=Qe,me=Le,pe=Ee,ce=Je,fe=Ie,j=Se;return d(),v("div",sa,[o("div",ta,[a(pe,{gutter:24},{default:l(()=>[a(Y,{xs:24,md:8},{default:l(()=>[Q((d(),M(A,{class:"profile-card"},{default:l(()=>[o("div",oa,[a(w,{size:100,src:n.value.avatar},{default:l(()=>[a(r,{size:50},{default:l(()=>[a(h(Ae))]),_:1})]),_:1},8,["src"]),a(p,{class:"upload-btn",circle:"",size:"small",onClick:le},{default:l(()=>[a(r,null,{default:l(()=>[a(h(Re))]),_:1})]),_:1})]),o("div",ra,[o("h2",null,_(n.value.username),1),n.value.realName?(d(),v("p",na,_(n.value.realName),1)):U("",!0),a(g,{type:re(n.value.role),size:"small"},{default:l(()=>[R(_(oe(n.value.role)),1)]),_:1},8,["type"])]),a(O),o("div",da,[n.value.studentId?(d(),v("div",ia,[a(r,null,{default:l(()=>[a(h(Te))]),_:1}),o("span",null,_(n.value.studentId),1)])):U("",!0),n.value.phone?(d(),v("div",ua,[a(r,null,{default:l(()=>[a(h(Be))]),_:1}),o("span",null,_(n.value.phone),1)])):U("",!0),n.value.email?(d(),v("div",ma,[a(r,null,{default:l(()=>[a(h($e))]),_:1}),o("span",null,_(n.value.email),1)])):U("",!0),o("div",pa,[a(r,null,{default:l(()=>[a(h(Fe))]),_:1}),o("span",null,"加入于 "+_(ne(n.value.createTime)),1)])]),a(O),o("div",ca,[o("div",{class:"stat-item",onClick:e[0]||(e[0]=t=>s.$router.push("/adoption/my"))},[o("div",fa,_(C.value.applications||0),1),e[16]||(e[16]=o("div",{class:"stat-label"},"领养申请",-1))]),o("div",{class:"stat-item",onClick:e[1]||(e[1]=t=>s.$router.push("/community?author="+n.value.id))},[o("div",va,_(C.value.dynamics||0),1),e[17]||(e[17]=o("div",{class:"stat-label"},"发布动态",-1))]),o("div",{class:"stat-item",onClick:e[2]||(e[2]=t=>s.$router.push("/rescue?author="+n.value.id))},[o("div",_a,_(C.value.rescues||0),1),e[18]||(e[18]=o("div",{class:"stat-label"},"救助信息",-1))])])]),_:1})),[[j,x.value]])]),_:1}),a(Y,{xs:24,md:16},{default:l(()=>[a(me,{modelValue:k.value,"onUpdate:modelValue":e[13]||(e[13]=t=>k.value=t),class:"profile-tabs"},{default:l(()=>[a(B,{label:"基本信息",name:"basic"},{default:l(()=>[a(A,null,{default:l(()=>[a(q,{ref_key:"basicFormRef",ref:F,model:i,rules:K,"label-width":"100px"},{default:l(()=>[a(f,{label:"用户名",prop:"username"},{default:l(()=>[a(y,{modelValue:i.username,"onUpdate:modelValue":e[3]||(e[3]=t=>i.username=t),disabled:""},null,8,["modelValue"])]),_:1}),a(f,{label:"真实姓名",prop:"realName"},{default:l(()=>[a(y,{modelValue:i.realName,"onUpdate:modelValue":e[4]||(e[4]=t=>i.realName=t),placeholder:"请输入真实姓名",maxlength:"50"},null,8,["modelValue"])]),_:1}),a(f,{label:"学号/工号",prop:"studentId"},{default:l(()=>[a(y,{modelValue:i.studentId,"onUpdate:modelValue":e[5]||(e[5]=t=>i.studentId=t),placeholder:"请输入学号或工号",maxlength:"20"},null,8,["modelValue"])]),_:1}),a(f,{label:"手机号",prop:"phone"},{default:l(()=>[a(y,{modelValue:i.phone,"onUpdate:modelValue":e[6]||(e[6]=t=>i.phone=t),placeholder:"请输入手机号",maxlength:"20"},null,8,["modelValue"])]),_:1}),a(f,{label:"邮箱",prop:"email"},{default:l(()=>[a(y,{modelValue:i.email,"onUpdate:modelValue":e[7]||(e[7]=t=>i.email=t),placeholder:"请输入邮箱",maxlength:"100"},null,8,["modelValue"])]),_:1}),a(f,null,{default:l(()=>[a(p,{type:"primary",loading:V.value,onClick:ee},{default:l(()=>[...e[19]||(e[19]=[R(" 保存修改 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(B,{label:"修改密码",name:"password"},{default:l(()=>[a(A,null,{default:l(()=>[a(q,{ref_key:"passwordFormRef",ref:S,model:u,rules:W,"label-width":"100px"},{default:l(()=>[a(f,{label:"旧密码",prop:"oldPassword"},{default:l(()=>[a(y,{modelValue:u.oldPassword,"onUpdate:modelValue":e[8]||(e[8]=t=>u.oldPassword=t),type:"password",placeholder:"请输入旧密码","show-password":""},null,8,["modelValue"])]),_:1}),a(f,{label:"新密码",prop:"newPassword"},{default:l(()=>[a(y,{modelValue:u.newPassword,"onUpdate:modelValue":e[9]||(e[9]=t=>u.newPassword=t),type:"password",placeholder:"请输入新密码（6-20位）","show-password":""},null,8,["modelValue"])]),_:1}),a(f,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[a(y,{modelValue:u.confirmPassword,"onUpdate:modelValue":e[10]||(e[10]=t=>u.confirmPassword=t),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),a(f,null,{default:l(()=>[a(p,{type:"primary",loading:V.value,onClick:ae},{default:l(()=>[...e[20]||(e[20]=[R(" 修改密码 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(B,{label:"我的收藏",name:"favorites"},{default:l(()=>[a(A,null,{default:l(()=>[Q((d(),v("div",ga,[!I.value&&N.value.length===0?(d(),M(ie,{key:0,description:"暂无收藏"})):(d(),v("div",wa,[(d(!0),v(Pe,null,Ue(N.value,t=>(d(),M(la,{key:t.id,cat:t,onClick:Ea=>s.$router.push(`/cats/${t.id}`)},null,8,["cat","onClick"]))),128))])),D.value>0?(d(),v("div",ya,[a(ue,{"current-page":b.page,"onUpdate:currentPage":e[11]||(e[11]=t=>b.page=t),"page-size":b.size,"onUpdate:pageSize":e[12]||(e[12]=t=>b.size=t),total:D.value,layout:"prev, pager, next",onCurrentChange:L},null,8,["current-page","page-size","total"])])):U("",!0)])),[[j,I.value]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),a(fe,{modelValue:P.value,"onUpdate:modelValue":e[15]||(e[15]=t=>P.value=t),title:"上传头像",width:"400px"},{footer:l(()=>[a(p,{onClick:e[14]||(e[14]=t=>P.value=!1)},{default:l(()=>[...e[21]||(e[21]=[R("取消",-1)])]),_:1})]),default:l(()=>[a(ce,{class:"avatar-uploader",action:X,headers:G,"show-file-list":!1,"on-success":te,"before-upload":se},{default:l(()=>[z.value?(d(),v("img",{key:0,src:z.value,class:"avatar-preview"},null,8,ba)):(d(),M(r,{key:1,class:"avatar-uploader-icon"},{default:l(()=>[a(h(Ke))]),_:1}))]),_:1})]),_:1},8,["modelValue"])])}}},Xa=ve(ha,[["__scopeId","data-v-94f86fa8"]]);export{Xa as default};
