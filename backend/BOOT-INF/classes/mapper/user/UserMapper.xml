<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campus.cat.module.user.mapper.UserMapper">

    <!-- 用户结果映射 -->
    <resultMap id="UserVOMap" type="com.campus.cat.module.user.dto.UserVO">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="real_name" property="realName"/>
        <result column="student_id" property="studentId"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="avatar" property="avatar"/>
        <result column="role" property="role"/>
        <result column="status" property="status"/>
        <result column="gender" property="gender"/>
        <result column="college" property="college"/>
        <result column="introduction" property="introduction"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="last_login_time" property="lastLoginTime"/>
    </resultMap>

    <!-- 分页查询用户列表 -->
    <select id="selectUserPage" resultMap="UserVOMap">
        SELECT
            id,
            username,
            real_name,
            student_id,
            phone,
            email,
            avatar,
            role,
            status,
            gender,
            college,
            introduction,
            view_count,
            like_count,
            create_time,
            update_time,
            last_login_time
        FROM user
        <where>
            <if test="query.username != null and query.username != ''">
                AND username LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.realName != null and query.realName != ''">
                AND real_name LIKE CONCAT('%', #{query.realName}, '%')
            </if>
            <if test="query.studentId != null and query.studentId != ''">
                AND student_id LIKE CONCAT('%', #{query.studentId}, '%')
            </if>
            <if test="query.phone != null and query.phone != ''">
                AND phone LIKE CONCAT('%', #{query.phone}, '%')
            </if>
            <if test="query.email != null and query.email != ''">
                AND email LIKE CONCAT('%', #{query.email}, '%')
            </if>
            <if test="query.role != null and query.role != ''">
                AND role = #{query.role}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.gender != null">
                AND gender = #{query.gender}
            </if>
            <if test="query.college != null and query.college != ''">
                AND college LIKE CONCAT('%', #{query.college}, '%')
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND (username LIKE CONCAT('%', #{query.keyword}, '%')
                     OR real_name LIKE CONCAT('%', #{query.keyword}, '%')
                     OR student_id LIKE CONCAT('%', #{query.keyword}, '%')
                     OR phone LIKE CONCAT('%', #{query.keyword}, '%')
                     OR email LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
            <if test="query.startTime != null and query.startTime != ''">
                AND create_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null and query.endTime != ''">
                AND create_time &lt;= #{query.endTime}
            </if>
        </where>
        <choose>
            <when test="query.sortBy == 'create_time'">
                ORDER BY create_time
            </when>
            <when test="query.sortBy == 'last_login_time'">
                ORDER BY last_login_time
            </when>
            <otherwise>
                ORDER BY create_time
            </otherwise>
        </choose>
        <if test="query.sortOrder == 'asc'">
            ASC
        </if>
        <if test="query.sortOrder == 'desc' or query.sortOrder == null">
            DESC
        </if>
    </select>

    <!-- 根据用户名查询用户信息 -->
    <select id="selectUserByUsername" resultMap="UserVOMap">
        SELECT
            id,
            username,
            real_name,
            student_id,
            phone,
            email,
            avatar,
            role,
            status,
            gender,
            college,
            introduction,
            view_count,
            like_count,
            create_time,
            update_time,
            last_login_time
        FROM user
        WHERE username = #{username}
    </select>

    <!-- 根据用户名查询用户实体（用于认证） -->
    <select id="selectByUsername" resultType="com.campus.cat.module.user.entity.User">
        SELECT
            id,
            username,
            password,
            real_name,
            student_id,
            phone,
            email,
            avatar,
            role,
            status,
            gender,
            college,
            introduction,
            view_count,
            like_count,
            create_time,
            update_time,
            last_login_time
        FROM user
        WHERE username = #{username}
    </select>

    <!-- 获取用户统计信息 -->
    <select id="selectUserStatistics" resultType="java.util.Map">
        SELECT
            COUNT(*) as totalUsers,
            COUNT(CASE WHEN status = 1 THEN 1 END) as activeUsers,
            COUNT(CASE WHEN status = 0 THEN 1 END) as disabledUsers,
            COUNT(CASE WHEN role = 'USER' THEN 1 END) as normalUsers,
            COUNT(CASE WHEN role = 'VOLUNTEER' THEN 1 END) as volunteers,
            COUNT(CASE WHEN role = 'ADMIN' THEN 1 END) as admins,
            COUNT(CASE WHEN role = 'SUPER_ADMIN' THEN 1 END) as superAdmins,
            COUNT(CASE WHEN DATE(create_time) = CURDATE() THEN 1 END) as todayNewUsers,
            COUNT(CASE WHEN DATE(create_time) >= DATE_SUB(CURDATE(), INTERVAL 7 DAY) THEN 1 END) as weekNewUsers,
            COUNT(CASE WHEN DATE(create_time) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN 1 END) as monthNewUsers
        FROM user
        WHERE 1=1
        <if test="universityId != null">
            <!-- TODO: 添加大学关联条件 -->
        </if>
    </select>

    <!-- 获取角色分布统计 -->
    <select id="selectRoleDistribution" resultType="java.util.Map">
        SELECT
            role,
            CASE
                WHEN role = 'USER' THEN '普通用户'
                WHEN role = 'VOLUNTEER' THEN '志愿者'
                WHEN role = 'ADMIN' THEN '管理员'
                WHEN role = 'SUPER_ADMIN' THEN '超级管理员'
                ELSE '未知'
            END as roleText,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM user), 2) as percentage
        FROM user
        WHERE 1=1
        <if test="universityId != null">
            <!-- TODO: 添加大学关联条件 -->
        </if>
        GROUP BY role
        ORDER BY count DESC
    </select>

    <!-- 获取用户增长趋势 -->
    <select id="selectUserGrowthTrend" resultType="java.util.Map">
        SELECT
            DATE(create_time) as date,
            DATE_FORMAT(create_time, '%Y-%m-%d') as formattedDate,
            COUNT(*) as newUsers,
            COUNT(CASE WHEN role = 'USER' THEN 1 END) as normalUsers,
            COUNT(CASE WHEN role = 'VOLUNTEER' THEN 1 END) as volunteers,
            COUNT(CASE WHEN role = 'ADMIN' THEN 1 END) as admins
        FROM user
        WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="universityId != null">
            <!-- TODO: 添加大学关联条件 -->
        </if>
        GROUP BY DATE(create_time)
        ORDER BY date ASC
    </select>

    <!-- 更新最后登录时间 -->
    <update id="updateLastLoginTime">
        UPDATE user
        SET last_login_time = NOW()
        WHERE id = #{userId}
    </update>

</mapper>